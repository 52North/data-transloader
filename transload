#!/usr/bin/env ruby -w -Ilib
require 'transloader'

# TODO: Clean up excessive arguments in methods

def get_station_metadata(source, user_id, station_id, data_urls, cache)
  case source
  when "environment_canada"
    provider = Transloader::EnvironmentCanadaProvider.new(cache)
    station = provider.load_station(station_id)
    station.save_metadata
  when "data_garrison"
    provider = Transloader::DataGarrisonProvider.new(cache)
    station = provider.get_station(user_id, station_id)
    station.download_metadata
    station.save_metadata
  when "campbell_scientific"
    provider = Transloader::CampbellScientificProvider.new(cache)
    station = provider.get_station(station_id, data_urls)
    station.download_metadata
    station.save_metadata
  else
    puts "Support for source not implemented"
  end
end

def get_station_observations(source, user_id, station_id, cache)
  case source
  when "environment_canada"
    provider = Transloader::EnvironmentCanadaProvider.new(cache)
    station = provider.load_station(station_id)
    station.save_observations
  when "data_garrison"
    provider = Transloader::DataGarrisonProvider.new(cache)
    station = provider.get_station(user_id, station_id)
    station.save_observations
  when "campbell_scientific"
    provider = Transloader::CampbellScientificProvider.new(cache)
    station = provider.get_station(station_id, [])
    station.save_observations
  else
    puts "Support for source not implemented"
  end
end

def put_station_metadata(source, user_id, station_id, cache, destination)
  case source
  when "environment_canada"
    provider = Transloader::EnvironmentCanadaProvider.new(cache)
    station = provider.load_station(station_id)
    station.get_metadata
    station.upload_metadata(destination)
  when "data_garrison"
    provider = Transloader::DataGarrisonProvider.new(cache)
    station = provider.get_station(user_id, station_id)
    station.get_metadata
    station.upload_metadata(destination)
  when "campbell_scientific"
    provider = Transloader::CampbellScientificProvider.new(cache)
    station = provider.get_station(station_id, [])
    # TODO: Rename "get" to "load" for file-loading operations
    station.get_metadata
    station.upload_metadata(destination)
  else
    puts "Support for source not implemented"
  end
end

def put_station_observations(source, user_id, station_id, cache, destination, date)
  case source
  when "environment_canada"
    provider = Transloader::EnvironmentCanadaProvider.new(cache)
    station = provider.load_station(station_id)
    # CHECK: Is this overwriting metadata?
    station.get_metadata
    station.save_metadata
    station.upload_metadata(destination)
    station.upload_observations(destination, date)
  when "data_garrison"
    provider = Transloader::DataGarrisonProvider.new(cache)
    station = provider.get_station(user_id, station_id)
    station.upload_observations(destination, date)
  when "campbell_scientific"
    provider = Transloader::CampbellScientificProvider.new(cache)
    station = provider.get_station(station_id, [])
    station.upload_observations(destination, date)
  else
    puts "Support for source not implemented"
  end
end

# Parse Args
args = Transloader::Args.new(ARGV)

# Determine action

case args.verb
when :get
  case args.object
  when :metadata
    get_station_metadata(args.source, args.user, args.station, args.data_urls, args.cache)
  when :observations
    get_station_observations(args.source, args.user, args.station, args.cache)
  end
when :put
  case args.object
  when :metadata
    put_station_metadata(args.source, args.user, args.station, args.cache, args.destination)
  when :observations
    put_station_observations(args.source, args.user, args.station, args.cache, args.destination, args.date)
  end
end
